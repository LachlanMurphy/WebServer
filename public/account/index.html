<!DOCTYPE html>
<html>
<head>
	<script src="https://cdn.socket.io/4.5.3/socket.io.min.js" integrity="sha384-WPFUvHkB1aHA5TDSZi6xtDgkF0wXJcIIxXhC6h8OT8EH3fC5PWro5pWJ1THjcfEi" crossorigin="anonymous"></script>

	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Account</title>
</head>
<body>
	<h1 id="title"></h1>
	<h3 id="firstName"></h3><h3>Change First Name: <input type="text" id="changeFirstName"></h3>
	<h3 id="lastName"></h3><h3>Change Last Name: <input type="text" id="changeLastName"></h3>
	<h3 id="email"></h3><h3>Change Email: <input type="text" id="changeEmail"></h3>
	<h3>Change Password: <input type="text" id="changePassword"></h3>
	<h3>Confirm New Password: <input type="text" id="confirmPassword"></h3>
	<input type="submit" value="Confirm Changes" onclick="sendChanges();">
</body>

<script type="text/javascript">
	const socket = io("https://account.lachlangmurphy.com");

	// Grab the user from the login stuff
	let param = new URLSearchParams(window.location.search);
	let key = param.get("user");

	if (key !== null) {
		socket.emit('getKeyMatch', key);
	}

	let user;
	socket.on('keyMatch', act => {
		user = act;

		document.getElementById('title').innerHTML = "Welcome " + user.firstName+" "+user.lastName;
	});
	socket.on('noKeyMatch', () => console.log("No key match found."));

	socket.on('changeAccountSuccess', data => {
		// To save some code just refresh the page
		socket.emit('requestKey', data.email);
		console.log("Changed account success");
	});

	socket.on('sendKey', key => {
		let p = new URLSearchParams();
		p.append('user', key);
		let url = "https://account.lachlangmurphy.com/account/?" + p.toString();
		window.location.replace(url);
	});

	function sendChanges() {
		if (document.getElementById('changePassword').value != document.getElementById('confirmPassword').value) return;

		data = {
			oldEmail: user.email,
			firstName: document.getElementById('changeFirstName').value,
			lastName: document.getElementById('changeLastName').value,
			email: document.getElementById('changeEmail').value,
			password: document.getElementById('changePassword').value
		}

		socket.emit('changeAccount', data);
		console.log("Changed Account");
	}
</script>

</html>